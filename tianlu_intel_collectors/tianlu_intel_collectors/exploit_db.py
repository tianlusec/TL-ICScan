import argparse
import csv
import io
import re
import sys
import requests
import codecs
from datetime import datetime
from typing import List, Optional

from .models import NormalizedCVE
from .utils import get_session, get_logger, measure_time

logger = get_logger(__name__)

EXPLOIT_DB_CSV_URL = "https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv"

@measure_time
def fetch_exploit_db():
    session = get_session()
    try:
        logger.info(f"Fetching Exploit-DB CSV from {EXPLOIT_DB_CSV_URL}...")
        with session.get(EXPLOIT_DB_CSV_URL, timeout=60, stream=True) as response:
            response.raise_for_status()
            f = codecs.getreader('utf-8')(response.raw)
            csv_reader = csv.reader(f)

            header = next(csv_reader, None)
            for row in csv_reader:
                if not row:
                    continue
                try:
                    parse_exploit_db_row(row)
                except Exception as e:
                    logger.error(f"Error parsing row: {e}")
                    continue
                
    except Exception as e:
        logger.error(f"Error fetching Exploit-DB data: {e}")

def parse_exploit_db_row(row: List[str]):
    if len(row) < 12:
        return

    edb_id = row[0]
    if not edb_id.isdigit():
        return

    description = row[2]
    date_published = row[3]
    verified = row[10]
    codes = row[11]
    
    cve_ids = re.findall(r'CVE-\d{4}-\d+', codes, re.IGNORECASE)
    
    if not cve_ids:
        return

    publish_date = None
    try:
        publish_date = datetime.strptime(date_published, "%Y-%m-%d")
    except:
        pass

    poc_risk_label = "verified_exploit" if verified == "1" else "unverified_exploit"
    
    extra = {
        "edb_id": edb_id,
        "edb_verified": verified,
        "edb_author": row[4],
        "edb_type": row[5],
        "edb_platform": row[6]
    }
    
    ref_url = f"https://www.exploit-db.com/exploits/{edb_id}"
    
    for cve_id in cve_ids:
        normalized = NormalizedCVE(
            cve_id=cve_id.upper(),
            title=f"Exploit-DB: {description}",
            description=description,
            publish_date=publish_date,
            references=[ref_url],
            exploit_exists=True,
            poc_sources=["exploit-db"],
            poc_repo_count=None,
            poc_risk_label=poc_risk_label,
            feed_version=datetime.now().isoformat(),
            extra=extra
        )
        print(normalized.model_dump_json())

if __name__ == "__main__":
    fetch_exploit_db()
