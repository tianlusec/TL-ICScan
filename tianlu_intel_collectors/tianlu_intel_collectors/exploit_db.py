import argparse
import csv
import io
import re
import sys
import requests
from datetime import datetime
from typing import List, Optional

from .models import NormalizedCVE
from .utils import get_session

EXPLOIT_DB_CSV_URL = "https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv"

def fetch_exploit_db():
    session = get_session()
    try:
        sys.stderr.write(f"Fetching Exploit-DB CSV from {EXPLOIT_DB_CSV_URL}...\n")
        response = session.get(EXPLOIT_DB_CSV_URL, timeout=60)
        response.raise_for_status()
        
        # Parse CSV
        content = response.content.decode('utf-8', errors='replace')
        csv_reader = csv.reader(io.StringIO(content))
        
        # Header is usually present? Let's check the first row.
        # The subagent said index 11 is codes.
        # Let's assume standard format.
        
        header = next(csv_reader, None)
        # We can try to detect header or just assume positions if header matches known columns.
        # id,file,description,date,author,type,platform,port,date_added,date_updated,verified,codes,tags,aliases,screenshot_url,source_url
        
        for row in csv_reader:
            if not row: continue
            try:
                parse_exploit_db_row(row)
            except Exception as e:
                # sys.stderr.write(f"Error parsing row: {e}\n")
                pass
                
    except Exception as e:
        sys.stderr.write(f"Error fetching Exploit-DB data: {e}\n")

def parse_exploit_db_row(row: List[str]):
    if len(row) < 12:
        return

    edb_id = row[0]
    description = row[2]
    date_published = row[3]
    verified = row[10]
    codes = row[11]
    
    # Extract CVEs
    cve_ids = re.findall(r'CVE-\d{4}-\d+', codes)
    
    if not cve_ids:
        return

    # Parse date
    publish_date = None
    try:
        publish_date = datetime.strptime(date_published, "%Y-%m-%d")
    except:
        pass

    # Risk Label
    # If verified == "1", we can say "verified_exploit" or "high_confidence"
    poc_risk_label = "verified_exploit" if verified == "1" else "unverified_exploit"
    
    extra = {
        "edb_id": edb_id,
        "edb_verified": verified,
        "edb_author": row[4],
        "edb_type": row[5],
        "edb_platform": row[6]
    }
    
    ref_url = f"https://www.exploit-db.com/exploits/{edb_id}"
    
    for cve_id in cve_ids:
        normalized = NormalizedCVE(
            cve_id=cve_id,
            title=f"Exploit-DB: {description}",
            description=description,
            publish_date=publish_date,
            references=[ref_url],
            exploit_exists=True,
            poc_sources=["exploit-db"],
            poc_repo_count=None, # Not applicable
            poc_risk_label=poc_risk_label,
            feed_version=datetime.now().isoformat(),
            extra=extra
        )
        print(normalized.model_dump_json())

if __name__ == "__main__":
    fetch_exploit_db()
